name: 发布 Docker 镜像到阿里云

on:
  push:
    tags:
      - '*'
  workflow_dispatch:
    inputs:
      name:
        description: "原因"
        required: false

jobs:
  build_and_push:
    name: 构建并推送多架构镜像
    environment: beilv
    runs-on: ubuntu-latest
    permissions:
      packages: write
      contents: read

    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: 解析标签并写入 VERSION
        run: |
          git fetch --tags --force --depth=1
          TAG=${GITHUB_REF#refs/tags/}
          echo "TAG=$TAG" >> $GITHUB_ENV
          echo "$TAG" > VERSION
          echo "构建标签版本: $TAG"

      - name: 设置 Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: 登录阿里云容器镜像服务
        uses: docker/login-action@v3
        with:
          registry: crpi-4z4v1n5g8hbg9g3x.cn-hangzhou.personal.cr.aliyuncs.com
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: 提取元数据 (标签)
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            crpi-4z4v1n5g8hbg9g3x.cn-hangzhou.personal.cr.aliyuncs.com/beilv-agent/new-api

      - name: 构建并推送镜像到阿里云
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64
          push: true
          tags: |
            crpi-4z4v1n5g8hbg9g3x.cn-hangzhou.personal.cr.aliyuncs.com/beilv-agent/new-api:${{ env.TAG }}
            crpi-4z4v1n5g8hbg9g3x.cn-hangzhou.personal.cr.aliyuncs.com/beilv-agent/new-api:latest
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          provenance: false
          sbom: false
